---
title: "MT Colloquium Preparation"
author: "Joao Vitor Krieger | joaovitorkgs"
date: "`r format(Sys.time(), '%B %d, %Y | %H:%M:%S | %Z')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    number_sections: true
    theme: united
    code_folding: hide
    df_print: paged
    highlight: tango
---

```{=html}
<style>
div.comment {background-color:#F0F6FF; border-radius: 5px; padding: 20px;}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA)

knitr::opts_knit$set(root.dir = "C:/Users/joaov/Dropbox/R Assignments/master-thesis/")

```

```{r, include = T}
pacman::p_load(
  # Core Data Manipulation and Tidying
  dplyr,        # Data manipulation: filtering, summarizing, mutating, and more
  tidyr,        # Data tidying and reshaping: pivoting, handling missing values
  janitor,      # Clean messy data (e.g., column names) and create summary tables
  
  # Data Import and Export
  readr,        # Read flat files (CSV, TSV) into tibbles
  readxl,       # Read Excel files (.xls, .xlsx) into data frames
  basedosdados, # Access Brazilian public data via BigQuery
  httr,         # Perform HTTP requests to interact with web APIs
  archive,      # Extract files from compressed archives (.zip, .tar.gz)
  
  # Data Visualization
  ggplot2,      # Create customizable data visualizations using the grammar of graphics
  scales,       # Format axes and legends (e.g., percentages, currencies)
  viridis,      # Color palettes for data visualization (colorblind-friendly)
  RColorBrewer, # Additional color palettes for plots
  
  # String Manipulation
  stringr,      # Simple and consistent string manipulation functions
  stringi,      # Advanced string manipulation with Unicode support
  
  # Date-Time Handling
  lubridate,    # Simplify date and time parsing and manipulation
  
  # Geographic and Spatial Data; specialized packages for Brazil
  geobr,        # Access Brazilian geographic data (e.g., shapefiles)
  deflateBR,     # Deflate nominal Brazilian Reais using price indexes
  sf,           # Handle spatial/geographic data in R
  
  # Reporting and Tables
  gt,           # Create publication-quality tables
  stargazer,    # Generate regression tables in LaTeX/HTML/text formats
  
  # Machine Learning and Statistics
  caret,        # Comprehensive machine learning framework (classification/regression)
  Metrics,      # Evaluate model performance (e.g., RMSE, MAE)
  glmnet,       # Regularized generalized linear models (Lasso, Ridge)
  earth,        # Multivariate Adaptive Regression Splines
  vip,          # Variable Importance Plots
  pdp,          # Partial Dependence Plots
  car,          # Companion to Applied Regression (diagnostic functions)
  DescTools,    # Tools for descriptive statistics
  rsample,      # Functions for resampling data
  plm           # Perform panel data analysis (fixed/random effects models)
)

```

------------------------------------------------------------------------

# Introduction

The goal of my research consists of assessing the fiscal impact (in terms of tax revenue) of a greater adoption of electrical vehicles (EV) in Brazil, focusing exclusively on the shift from passenger cars with internal combustion engines (ICE) to plug-in/battery powered electric vehicles (BEV).

For that, I intend to calculate tax revenue scenarios based on two variables:

1.  **Vehicle Stock:** total registered BEVs in a given moment. This variable will be used as input to calculate revenues from registration and annual vehicle tax.

2.  **Energy Use:** vehicle stock and vehicle activity. This variable will be used as input to calculate revenue (or the loss thereof) from taxes on fuel.

To calculate the first variable, I intend to use historical data on the country's fleet of passenger vehicles of all kinds and other relevant data (population size per state and city, income distribution on state level, vehicle prices) to estimate the current rates of BEV adoption in different states, and then use this information to extrapolate the data or run projections on how the BEV stock might grow in a time frame of 10-15 years.

To calculate second variable, I intend to use data on fuel sales and fuel consumption, as well as other information (such as average vehicle activity, measured in kilometers driven per year in different states). This variable will also be calculated with the first variable as input.

**This RMD file outlines the overall results I have achieved so far as part of my MT research and data work, which revolve mostly on calculating the first variable**. It also includes some contextual information which will be expanded as part of the final version of the thesis, as well as of the key data used, descriptive statistics, and results from the models attempted as of February 28.

The methods and results in this file draw mostly from these sources:

-   OECD/ITF (2019), Tax Revenue Implications of Decarbonising Road Transport: Scenarios for Slovenia, OECD Publishing, Paris, <https://doi.org/10.1787/87b39a2f-en/>

-   Boehmke, B., & Greenwell, B.M. (2019). Hands-On Machine Learning with R (1st ed.). Chapman and Hall/CRC. <https://doi.org/10.1201/9780367816377>

-   Hyndman, R.J., & Athanasopoulos, G. (2018) Forecasting: principles and practice, 2nd edition, OTexts: Melbourne, Australia. [https://otexts.com/fpp2](https://otexts.com/fpp2/index.html){.uri}.

------------------------------------------------------------------------

# Context

## Stock of passenger cars

Brazil has had a significant growth of its BEV stock in the past 10 years, with a growth from 1600 registered BEVs in 2013 to more than 20,600 as of early 2025. While the number of other vehicles has also continued to grow, as indicated in the plot below, this growth of the BEV fleet could point to an early stage of a trend where these vehicles can take up a larger share of the country's fleet.

```{r}
setwd("C:/Users/joaov/Dropbox/R Assignments/master-thesis/")
yearly_results_agg_long <- read_csv("3_processed_data/fleet_yearly_agg_long.csv")

ggplot(yearly_results_agg_long, aes(x = as.integer(year), y = Count, color = Category)) +
  geom_line(linewidth = 2) +
  geom_point(size = 3) +
  theme_bw() +
  scale_x_continuous(breaks = seq(2013, 2024, by = 1)) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::trans_breaks("log10", function(x) 10^x), # Powers of 10
    labels = scales::comma # Readable labels with commas
  ) +
  theme(
    panel.grid.major.y = element_line(color = "gray", linetype = "dashed"), # Dashed grid lines for y-axis
    panel.grid.minor.y = element_blank() # Remove minor grid lines for clarity
  ) +
  labs(
    x = "Year",
    y = "Number of Registered Vehicles (log)",
    title = "Evolution of Registered Vehicles in Brazil per Combustible Type",
    subtitle = "Source: National Traffic Secretariat, 2024",
    color = "Category"
  )

```

<br>

## Geographic Distribution of BEVs

The adoption of BEVs has remained heterogeneous among Brazilian cities and states. Factors such as income, level of urbanisation, population size and density, consumer preferences, and available infrastructure may play a role. The plots below illustrate different distributions of the number of BEVs among states, including the total fleet per state, BEV per capita, and share of BEVs as part of the total fleet of passenger cars).

```{r}

setwd("C:/Users/joaov/Dropbox/R Assignments/master-thesis/")

fleet_electric_vehicles_all_years <- read_csv("3_processed_data/fleet_electric_vehicles_all_years.csv")
pop_city <- read_csv("1_raw_data/0_demographics/pop_city.csv")
state_df <- geobr::read_state(year = 2020,showProgress = FALSE) 


# Create a string to use as common key to join the data frames
state_df$UF <- state_df$name_state %>%
  stringi::stri_trans_general("Latin-ASCII") %>%
  toupper()

# Join electric vehicle df with geographic info on the states
fleet_electric_vehicles_all_years <- fleet_electric_vehicles_all_years %>% 
  left_join(state_df, by = "UF") %>% 
  select(code_state, abbrev_state, name_state, code_region, name_region, geom, total_electric_vehicles, total_vehicles, percentage, year) 

# Update variable name
fleet_electric_vehicles_all_years$name_state <- tolower(fleet_electric_vehicles_all_years$name_state)


# Adding State population to the data frame
state_pop <- pop_city %>% 
  group_by(sigla_uf) %>% 
  summarize(total_pop = sum(populacao)) %>% 
  rename(abbrev_state = sigla_uf)

electric_vehicles_per_state <- fleet_electric_vehicles_all_years %>% 
  filter(year == 2022) %>% 
  left_join(state_pop, by = "abbrev_state")

electric_vehicles_per_state <- electric_vehicles_per_state %>% 
  mutate(vehicle_per_capita = total_vehicles/total_pop,
         electric_vehicle_per_capita = total_electric_vehicles/total_pop)

# Convert the df to generate the map
electric_vehicles_per_state <- st_as_sf(electric_vehicles_per_state)

# Update the df to make the percentage column numeric
electric_vehicles_per_state$percentage_num <- as.numeric(sub("%", "", electric_vehicles_per_state$percentage))

# Create a variable for the theme in the plots
no_axis <- theme(axis.title=element_blank(),
                 axis.text=element_blank(),
                 axis.ticks=element_blank())

# Percentage of electric vehicles per State

options(scipen = 999)

ggplot() +
  geom_sf(data=electric_vehicles_per_state, aes(fill=total_electric_vehicles), color=NA, size=.15) +
  labs(
    title = "BEV Stock in Brazil in 2024",
    subtitle = "Total registered Electrical Vehicles per State",
    fill = "Total Vehicles") +
  geom_sf_text(data=electric_vehicles_per_state, aes(label=abbrev_state), size=2, color="black") +
  scale_fill_distiller(palette="Purples", name="Total Vehicles", direction = 1, labels = scales::comma_format()) + 
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#ffffff", color = NA)
  ) +
  no_axis

```

<br>

While useful to show the distribution of BEVs in the country, the states with a darker shade of blue above are also the states with the larger population sizes in Brazil. While this correlation is somewhat obvious, it is useful to understand where most of the registered BEVs are concentrated.

```{r}
# Total Vehicles per Capita
ggplot() +
  geom_sf(data=electric_vehicles_per_state, aes(fill=electric_vehicle_per_capita), color=NA, size=.15) +
  labs(
    title = "BEV stock in Brazil in 2024",
    subtitle = "Registered BEVs per Capita per State",
    fill = "Vehicles per Capita") +
  geom_sf_text(data=electric_vehicles_per_state, aes(label=abbrev_state), size=2, color="black") +
  scale_fill_distiller(palette="Blues", name="BEV per Capita", direction = 1) + 
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#ffffff", color = NA)
  ) +
  no_axis

```

<br>

When looking into BEV per capita, States with a darker shade of purple (showing a bigger share of BEV per capita) may point to states with a greater level of urbanization (as PR and its capital, Curitiba, or the country's capital, Brasilia), or to specific local policies.

```{r}

# Share of BEVs as part of the total vehicle fleet
ggplot() +
  geom_sf(data=electric_vehicles_per_state, aes(fill=percentage_num), color=NA, size=.15) +
  labs(
    title = "BEV stock in Brazil in 2024",
    subtitle = "BEV fleet percentage of total vehicle fleet by Brazilian State",
    fill = "Vehicles per Capita") +
  geom_sf_text(data=electric_vehicles_per_state, aes(label=abbrev_state), size=2, color="black") +
  scale_fill_distiller(palette="BuPu", name="% of Total Fleet", direction = 1) + 
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#ffffff", color = NA)
  ) +
  no_axis

```

<br>

Finally, exploring the data on the share of BEVs from the total passenger car fleet in each state, a similar pattern emerges when comparing plots 3 and 4.

<br>

## Tax revenue

Based on this data and the expectation that the BEV stock continues to growh, especially in the more populated, dense, and urbanized regions of the country, the future adoption of BEV in the place of ICE might represent a change in the tax revenue which currently is levied from fuel sales, vehicle stock and activity from conventional gasoline or hybrid vehicles.

To illustrate this, the plot below shows the trend of how the aggregate tax revenue from the past ten years related to fuel sales has changed and what trends there might be. In the timeframe examined, the only relevant external shock has been that of the COVID-19 pandemic, but the data on (nominal) tax revenue seems to be growing steadily.

```{r}
setwd("C:/Users/joaov/Dropbox/R Assignments/master-thesis/")
federal_gasstation_fueltaxes <- read_csv("3_processed_data/taxrev_federal_gasstation_fueltaxes.csv")


ggplot(federal_gasstation_fueltaxes, aes(x = ano_mes_date,  y = fuel_taxes/1000000000)) +
  geom_line(linewidth = 1) +  # Line plot for each 'tipo_consumo'
  theme_bw() +                  # Clean theme
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +  # Show only the first month of each year
  scale_y_continuous(labels = scales::comma) +               # Format y-axis labels
  labs(
    x = "Year",
    y = "Total Tax Revenue per Month (Billion BRL)",
    title = "Total Federal Tax Revenue levied on Fuel-Related Economic Activities",
    subtitle = "Source: Special Secretariat of the Federal Revenue of Brazil (RFB), 2024",
    caption = "Note: Data related to firms registered under G category only, which includes gas stations and retail sale of fuels."
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Tilt x-axis labels
    plot.caption = element_text(hjust = 0))

```

<br>

With climate change as a backdrop and other factors that influence the Brazilian market for ICEs and BEVs — such as technology changes and the industry's convergence to BEVs (Dumas and Dugoua, 2024), the effects of the 2024 tax reform, and potential shifts on consumer preferences — this trend on fuel sales and usage of fossil fuels may behave differently in the future.

------------------------------------------------------------------------

# Data used

## Overview

All data used has been obtained from publicly available data from Brazilian official sources, including:

-   National Traffic Secretariat (2024): fleet size per vehicle type (monthly data on city level).
-   Special Secretariat of the Federal Revenue of Brazil (RFB): income distribution and tax revenue.
-   Peixoto (2024): average vehicle prices by vehicle/fuel type (monthly data on national level).
-   Base dos Dados (2024): demographic and geographic data, including population size per city and state.

The data frames loaded below are already the product of the project's pipeline, including data scraping or downloading, cleaning and organizing for the purpose of this analysis.

```{r}

setwd("C:/Users/joaov/Dropbox/R Assignments/master-thesis/")

# Loading the data frames

fleet_2013_2024_clean <- read_csv("./3_processed_data/fleet_2013_2024_id_clean.csv")
price_df              <- read_csv("./3_processed_data/fipe_price_monthly_trends_deflated.csv")
income_data_wide_uf   <- read_csv("./3_processed_data/income_data_wide_uf.csv")

# Further transformation for the models

## Organizing population data and adding months

months <- fleet_2013_2024_clean %>% 
  arrange(date) %>%  
  distinct(date) %>%  
  mutate(months_nr = row_number()) 

fleet_df <- fleet_2013_2024_clean %>% 
  mutate(ev_pc        = electric / populacao,
         ff_pc        = (gasoline+diesel)/populacao,
         log_electric = log(electric),
         log_ff       = log(gasoline+diesel),
         log_pop      = log(populacao)) %>% 
  filter(log_electric >= 0) %>% 
  left_join(months, by="date")

fleet_df_b_city <- fleet_df %>% 
  left_join(price_df, by = "date") 

fleet_df_b_uf <- fleet_df %>% 
  left_join(price_df, by = "date") %>% 
  group_by(sigla_uf, date, months_nr) %>% 
  summarize(diesel     = sum(diesel),
            ethanol    = sum(ethanol),
            gasoline   = sum(gasoline),
            other      = sum(other),
            electric   = sum(electric),
            gas        = sum(gas),
            population = sum(populacao))

## Adding price information and grouping by state
fleet_df_b_uf <- fleet_df %>% 
  left_join(price_df, by = "date") %>% 
  group_by(sigla_uf, date, year, month, months_nr) %>% 
  summarize(diesel     = sum(diesel),
            ethanol    = sum(ethanol),
            gasoline   = sum(gasoline),
            other      = sum(other),
            electric   = sum(electric),
            gas        = sum(gas),
            population = sum(populacao),
            mean_gas   = mean(mean_price_gasoline),
            mean_hyb   = mean(mean_price_hybrid),
            mean_ev    = mean(mean_price_electric),
            median_gas = mean(median_price_gasoline),
            median_hyb = mean(median_price_hybrid),
            median_ev  = mean(median_price_electric),
            min_gas    = mean(min_price_gasoline),
            min_hyb    = mean(min_price_hybrid),
            min_ev     = mean(min_price_electric)) %>% 
  mutate(ff_pc        = (gasoline+diesel)/population,
         log_ff       = log(gasoline+diesel),
         log_pop      = log(population))

## Adding income distribution data
fleet_df_c <- fleet_df_b_uf %>% 
  left_join(income_data_wide_uf, by = c("year", "sigla_uf")) %>% 
  drop_na()


```

------------------------------------------------------------------------

## Descriptive statistics

### BEV stock and population size

The table below has a summary of the data frame combining population size ("`populacao`") on city level with the existing fleet of passenger cars by fuel type.

```{r, results = 'asis'}

fleet_2013_2024_clean <- fleet_2013_2024_clean %>% 
  mutate(id_municipio = as.character(id_municipio))

stargazer(as.data.frame(fleet_2013_2024_clean),
          title="Table 1: Summary statistics of data on pop. size and vehicle stock",
          column.sep.width = "15pt",
          digits=0,
          type = "html")

```

<br>

Exploring the data visually, I find that population has a clear positive correlation with the BEV fleet size, though this may be somewhat obvious.

```{r}
ggplot(data = fleet_df_c, aes(x=population, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("EV Adoption vs. Population Size in in Brazilian States")+
  theme_bw() +
  ylab("Number of Registered Electric Vehicles (log)") +
  xlab("Population Size (log)") +
  scale_x_continuous(trans = "log10", labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4)  +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

<br>

### Price information

I have obtained a table with monthly prices of all vehicles being commercialized (new or used) in Brazil in a given month and year, from 2013 to 2022. The primary data is produced by FIPE, a research foundation that maintains a database on car prices to use as a parameter for individual transactions and valuation of any given car. I obtained this data from a secondary source (Peixoto, 2022), which scraped data from FIPE's website and made it publicly available.

By grouping data based on each model's fuel source (e.g. battery, gasoline, ethanol or hybrid), I have obtained mean, median, minimum and maximal prices, as well as the number of models available in a given month and year.

```{r, results = 'asis'}

stargazer(as.data.frame(price_df),
          title="Table 2: Summary statistics of data on vehicle price",
          column.sep.width = "3pt",
          digits=0,
          type = "html")

```

<br>

When plotting the data, BEV prices and BEV stock seem to have some degree of correlation, suggesting that more BEVs are bought as more affordable vehicles are available in the Brazilian market. However, the data points are oddly spread in the plot, as I do not have an explanation for these two clusters that appear in the plot bellow.

Note: each data point in the plot represents the price of the cheapest BEV model ("`min_price_electric`") available in the Brazilian market in a given month, and the BEV stock size in the corresponding month.

```{r}
fleet_df_c %>% 
  filter(year > 2015) %>% 
  group_by(date, year) %>% 
  summarize(
    ev_price = mean(min_ev)/1000,
    electric = mean(electric)) %>% 
  ggplot(aes(x=ev_price, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  labs(
    title = "BEV Adoption vs. BEV minimum price in Brazil (2018-2022)",
  ) +
  theme_bw() +
  ylab("Number of Registered BEV (log)") +
  xlab("BEV average price (thousand BRL)") +
  scale_x_continuous(labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 0, hjust = 1)
  ) 

```

<br>

Exploring the yearly average prices for the most affordable models in the Brazilian market shows a trend in which prices are becoming cheaper as time passes.

```{r}

fleet_df_c %>% 
  filter(year > 2016) %>% 
  group_by(year) %>% 
  summarize(
    ev_price = mean(min_ev)/1000) %>% 
  ggplot(aes(x = year, y = ev_price)) +
  geom_line() +
  geom_point(size = 3) +
  labs(
    title = "BEV Average Price Evolution in Brazil (2016-2022)",
    x = "Year",
    y = "BEV Average Price (thousand BRL)"
  ) +
  theme_bw() +
  scale_x_continuous(breaks = seq(2016, 2022, 1)) +
  scale_y_continuous(labels = scales::comma) +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

```

<br>

When showing monthly data, the trend of price values behaves in an unexpected way between 2018 and 2019, which might demand some more careful revision of the available data at hand before plugging it into the models.

```{r}

fleet_df_c %>% 
  filter(year > 2016) %>% 
  mutate(month = floor_date(date, "month")) %>%
  group_by(month) %>% 
  summarize(
    ev_price = mean(min_ev)/1000,
    electric = mean(electric)) %>% 
  ggplot(aes(x = month, y = ev_price)) +
  geom_line() +
  geom_point() +
  labs(
    title = "BEV Minimum Price Evolution in Brazil (2016-2022)",
    x = "Date",
    y = "Average Price (thousand BRL)"
  ) +
  theme_bw() +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  scale_y_continuous(labels = scales::comma) +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```

### Income Information

For data on income, I used data published by the Brazilian national treasury on income distribution. The original data set lists yearly data on different kinds of taxable income classes per income percentile. I have adjusted the values to show deflated BRL, and used only the bottom 10th percentile, the median, and the top 90 and 100 percentiles.

```{r, results = 'asis'}

stargazer(as.data.frame(income_data_wide_uf),
          title="Table 3: Summary statistics of data on income distribution",
          column.sep.width = "3pt",
          digits=0,
          type = "html")

```

When visualizing the data, the scatterplot below suggests that average taxable income of the richest percentile also seems to have a correlation with number of registered BEVs in a given month. This suggests that acquiring an BEV seems to be inaccessible for most of the population.

```{r}
fleet_df_c %>% 
  group_by(year, sigla_uf) %>% 
  summarize(
    avg_taxable_income_100 = mean(avg_taxable_income_100),
    electric = mean(electric)) %>% 
  ggplot(aes(x=avg_taxable_income_100, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("BEV Adoption vs. Average income of top 100th Percentile in Brazilian States")+
  theme_bw() +
  ylab("Number of Registered BEVs (log)") +
  xlab("Average Taxable Income of the 100th Percentile (log)") +
  scale_x_continuous(trans = "log10", labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4) +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

<br>

This correlation is not clear when looking into the average income for the 50th percentile (median). The plots suggest a negative correlation.

```{r}
fleet_df_c %>% 
  group_by(year, sigla_uf) %>% 
  summarize(
    avg_taxable_income_50 = mean(avg_taxable_income_50),
    electric = mean(electric)) %>% 
  ggplot(aes(x=avg_taxable_income_50, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("BEV Adoption vs. Average income of the top 50th Percentile in Brazilian State")+
  theme_bw() +
  ylab("Number of Registered BEVs (log)") +
  xlab("Average Taxable Income of the 50th Percentile (log)") +
  scale_x_continuous(trans = "log10", labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4)+
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

<br>

This correlation is also not clear when looking into the average income for the bottom 10th percentile. The plots suggest a negative correlation.

```{r}

# Also not true for the bottom 10 percentile

fleet_df_c %>% 
  group_by(year, sigla_uf) %>% 
  summarize(
    avg_taxable_income_10 = mean(avg_taxable_income_10),
    electric = mean(electric)) %>% 
  ggplot(aes(x=avg_taxable_income_10, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("BEV Adoption vs. Average income of the bottom 10th Percentile in Brazilian State")+
  theme_bw() +
  ylab("Number of Registered BEVs (log)") +
  xlab("Average Taxable Income of the 50th Percentile (log)") +
  scale_x_continuous(labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4)+
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```

<br>

------------------------------------------------------------------------

# Models

In order to project the BEV stock in Brazil in relation to future years by using past data, I have attempted to establish models that can correctly predict the information already at hand. The goal is to find good predictors to explain the growth in the BEV stock, which are statistically significant, and that have a logical mechanism that explains the relationship. Based on the coefficients found and the accuracy of the model, I will then create synthetic data which extrapolates the current BEV stock to the future years, which will then be used to examine the impact of electrifying the passenger vehicle fleet in Brazil on tax revenue.

The predictors chosen thus far and their rationale were the following:

-   **Population size**: bigger cities and states are expected to have a more developed infrastructure, which would include charging infrastructure, as well as a bigger demand and offer for BEV.

-   **Fossil fuel Vehicles** : instead of owning multiple cars, I would expect a gradual substitution of ICEs by BEVs as the stock of the latter increases.

-   **Time**: due to recent trends, evolving consumer preferences, markets and available technologies, as well as a growing concern with climate change in recent years and the negative impacts of CO2 emitting cars, time (number of months passed) was included as a predictor.

-   **Vehicle prices**: the first BEV models available in 2013 were twice as expensive as the cheapest models currently available. As BEVs become more affordable, the overall BEV stock is expected to increase.

-   **Income**: in spite of recent BEVs models becoming gradually less expensive, the cost of the cheapest models still is significantly higher than that of ICEs. This would mean that cities and states with a higher average income of the top percentiles of the population would have a bigger BEV stock as well.

These predictors might also have some degree of multicollinearity. For example, larger cities and states tend to also be richer. Population growth and price changes are also correlated with the predictor related to time. This means that the predictors might introduce bias or have a limited capacity of explaining the increase in BEV in the models.

## Linear regressions

The first and most simple models were simple linear regressions (OLS), where the BEV stock (the log-transformed number of registered BEVs in a given month in all Brazilian states) was regressed on population size and time. Another model includes the interaction between time and population, as well as with the number of other kinds of vehicles in the fleet.

```{r, results = 'asis'}

model1 <- lm(log(electric) ~ log(population) * months_nr, 
             data = fleet_df_c)

model2 <- lm(log(electric) ~ log(population) * months_nr + log(min_ev) + log(mean_gas) + log(mean_hyb),
             data = fleet_df_c)

model3 <- lm(log(electric) ~ log(population) * months_nr + log(min_ev) + log(mean_gas) + log(mean_hyb) +
               log(avg_taxable_income_50) + log(avg_taxable_income_100),
             data = fleet_df_c)


stargazer(model1, model2, model3, type = "html",
          title=
            "Table 4: BEV stock regressed on population size, time, price & income (linear regression)",
          single.row= FALSE,
          column.labels =c("Model 1","Model 2", "Model 3", "Model 4"),
          covariate.labels=c("Population (log)",
                             "Months",
                             "Vehicle price - electric (log)",
                             "Vehicle price - gasoline (log)",
                             "Vehicle price - hybrid (log)",
                             "Avg. Income - 50th perc. (log)",
                             "Avg. Income - 100th perc. (log)",
                             "Vehicle price - hybrid (log)",
                             "Months : Population (log)"),
          keep.stat = c("rsq", "f"),
          notes.align = "l",
          dep.var.labels=c("EV stock (log)"))

```

<br>

**Interpretation:**

The above regression tables shows state-level data where the BEV stock is regressed on log-transformed population, months, average car prices per vehicle type and an interactions between population and time-related variable.

The regression with the most variables seems to perform well, based on the statistical significance of the coefficients, as well as the R² and F-Statistic values. It corroborates some of the initial assumptions and expected relationships for most of the independent variables, including increases on population size, time effects, and the influence of prices of vehicles, which also have the correct direction (e.g. BEV prices have a negative coefficient).

As for the effect of income — measured here as the annual average taxable income of the 50th and 100th top percentiles — in each state, the median average income seems to have a positive correlation, but the average income of the top earners in Brazilian states has no statistically significant effect, with an unexpected negative correlation.

## Panel Data and Fixed-Effects

As an improvement to the linear regressions above, the following regressions incorporate fixed effects for the used units of observations (i.e. states), in order to focus on variance within units and account for the natural and significant differences between states.

```{r, results = 'asis'}


panel_data <- pdata.frame(fleet_df_c, index = c("sigla_uf", "date"))

fe_model_1 <- plm(log(electric) ~ log(population) + as.factor(months_nr),
                  data  = panel_data,
                  model = "within")

fe_model_2 <- plm(log(electric) ~ log(population) + log(min_ev) + log(mean_gas) + log(mean_hyb) + as.factor(months_nr),
                  data  = panel_data,
                  model = "within")

fe_model_3 <- plm(log(electric) ~ log(population) + log(min_ev) + log(mean_gas) + log(mean_hyb) + log(avg_taxable_income_50) + log(avg_taxable_income_100) + as.factor(months_nr),
                  data  = panel_data,
                  model = "within")


stargazer(fe_model_1, fe_model_2, fe_model_3, type = "text",
          title = "Table 5: BEV stock regressed on population size, time, vehicle prices and income with panel data and fixed effects",
          single.row = FALSE,
          dep.var.labels = c("EV stock (log)"),
          covariate.labels=c("Population (log)",
                             "Vehicle price - electric (log)",
                             "Vehicle price - gasoline (log)",
                             "Vehicle price - hybrid (log)",
                             "Avg. Income - 50th perc. (log)",
                             "Avg. Income - 100th perc. (log)"),
          column.labels = c("Model 1", "Model 2", "Model 3"),
          keep.stat = c("rsq", "f"),
          notes.align = "l",
          omit = "as.factor\\(months_nr\\)[0-9]+",
          intercept.bottom = TRUE)


fe_model_1_with_intercept <- within_intercept(fe_model_1, return.model = TRUE)
fe_model_2_with_intercept <- within_intercept(fe_model_2, return.model = TRUE)
fe_model_3_with_intercept <- within_intercept(fe_model_3, return.model = TRUE)

# Use these modified models in stargazer
stargazer(fe_model_1_with_intercept, fe_model_2_with_intercept, fe_model_3_with_intercept, 
          type = "text",
          title = "Table 5: BEV stock regressed on population size, time, vehicle prices and income with panel data and fixed effects",
          single.row = FALSE,
          dep.var.labels = c("EV stock (log)"),
          covariate.labels=c("Population (log)",
                             "Vehicle price - electric (log)",
                             "Vehicle price - gasoline (log)",
                             "Vehicle price - hybrid (log)",
                             "Avg. Income - 50th perc. (log)",
                             "Avg. Income - 100th perc. (log)"),
          column.labels = c("Model 1", "Model 2", "Model 3"),
          keep.stat = c("rsq", "f"),
          notes.align = "l",
          omit = "as.factor\\(months_nr\\)[0-9]+")

```

<br>

**Interpretation:**

The regression with panel data and fixed-effects has a better performance, with the R² value in all three models being around 0.93. It also indicates an increased effect from population and vehicle prices, especially for the price of BEVs, when compared to the linear regressions with no fixed effects. The results from table 5 suggest that, on average, a 1% decrease on the average vehicle price for the cheapest BEV available on the market on a given month is associated to a 5.4% increase on the BEV stock.

As for the effect of income, the median average income seems to have a now a negative effect, as well as the average income of the top earners in each state. This is an unexpected effect of the correlation between income and BEV stock.

<br>

## Regularized Regressions

A further step in the analysis was to regularize the estimate coefficients, to reduce variance and decrease out of sample error. The following code shows applications of the ridge regression, in which a tuning parameter (`lambda`) has been added to force correlated coefficients and less important predictors toward zero, thus reducing collinearity. Additionally, a Lasso (least absolute shrinkage and selection operator) penalty was also introduced, to push correlated coefficients and irrelevant predictors to zero, using automated feature selection.

For this section of analysis, additional features were included to the data set, such as mean, median and minimum prices for BEVs, hybrid and gasoline vehicles; the fleet size for vehicles of all engine/fuel types; as well as the log-transformed population size (`log_pop`) and size of the vehicle stock with combustion engines (`log_ff`), and the ratio of vehicles with combustion engines per capita (`ff_pc`).

The goal of using these methods is to identifying a model where the MSE (Mean Squared Error) is minimized. In this case, the MSE will be used to determine the statistical significance of the factors or predictors under study.

```{r}

# Create training  feature matrices
# we use model.matrix(...)[, -1] to discard the intercept

library(glmnet)

X <- modglmnetX <- model.matrix(log(electric) ~ ., fleet_df_c)[, -1]
Y <- log(fleet_df_c$electric)

# Ridge model
ridge <- glmnet(
  x = X,
  y = Y,
  alpha = 0
)

# Lasso model
lasso <- glmnet(
  x = X,
  y = Y,
  alpha = 1
)

par(mfrow = c(1, 2))
# plot ridge model
plot(ridge, xvar = "lambda", main = "Ridge penalty\n\n")

# plot lasso model
plot(lasso, xvar = "lambda", main = "Lasso penalty\n\n")


```

<br>

The plot above shows the coefficients' value being pushed towards zero as the `lambda` value increases. However, differently from the examples in Boehmke & Greenwell (2019), where dashed lines were plotted for the `lambda` values with the smallest MSE and at one standard error of the minimum MSE, this model returns a `NULL` value for these `lambda` values:

```{r, show = T}
ridge$lambda.min
ridge$lambda.1se
lasso$lambda.min
lasso$lambda.1se
```

<br>

This might mean that the algorithm was unable to determine an optimal regularization parameter for the data set being used, either because the model is not converging to any of the attempted `lambda` values, or because the multicollinearity among the predictors makes it difficult for the algorithm to determine the appropriate `lambda` value. Also, given the good performance of the previous linear regressions, it might mean that the model is overfitted, i.e. it performs well to explain the relationship between independent and dependent variables with the data existing, but it performs poorly with new data.

Following Boehmke & Greenwell (2019), a workaround to this was to use the **caret** package to automate the tuning process (i.e. chosing the parameters to optimize the model and find the lowest regularized MSE). The code output below shows the chosen `lambda` value, which penalizes the existing predictors; and the `alpha` value (which determines whether the **glmnet** package should perform a ridge (`alpha = 0`), lasso (`alpha = 1`) or elastic net (`0 < alpha < 1`) model.

```{r}

# for reproducibility
set.seed(123)

# grid search across 
cv_glmnet <- train(
  x = X,
  y = Y,
  method = "glmnet",
  preProc = c("zv", "center", "scale"),
  trControl = trainControl(method = "cv", number = 10),
  tuneLength = 10
)

cv_glmnet$results %>%
  filter(alpha == cv_glmnet$bestTune$alpha, lambda == cv_glmnet$bestTune$lambda)

```

<br>

The results show an `alpha` value of 0.3, which means the model uses an elastic net regression, with a heavier ridge penalty. However, the `lambda` value is very low, close to 0, which means the model is applying very little regularization, thus behaving similarly to a standard linear regression, without performing much feature selection.

When using this model to predict the number of BEVs using training data, the algorithm returns an RSME of 368.

```{r}

# predict number of electric vehicles on training data
pred <- predict(cv_glmnet, X)

# compute RMSE of transformed predicted
RMSE(exp(pred), exp(Y))

```

<br>

While this may be a good enough standard error for most of the states or for the aggregated fleet (on national level), the error makes the predicted values statistically insignificant for three out of the 25 Brazilian states (AC, AP, RR), as seen in the plot below.

```{r}
fleet_df_c %>% 
  select(year, sigla_uf, electric) %>% 
  filter(year == 2022) %>% 
  group_by(sigla_uf) %>% 
  summarize(
    BEVs  = max(electric)
  ) %>% 
  arrange((BEVs)) %>% 
  mutate(sigla_uf = factor(sigla_uf, levels = sigla_uf)) %>% 
  ggplot(aes(y = sigla_uf, x = BEVs)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = comma(BEVs)), hjust = -0.1, size = 3) +
  scale_x_continuous(labels = comma) +
  ggtitle("Number of BEVs registered per Brazilian State in 2022") +
  xlab("Number of Observations") +
  ylab("Brazilian States") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```

<br>

Lastly, the plot below shows the 20 variables with the greatest importance, as determined by the magnitude of the standardized coefficients.

```{r}

vip(cv_glmnet, num_features = 20, geom = "point")


```

<br>

This shows the most influential features in the model were different from the linear regressions with no regularized estimate coefficients. In this plot, the log transformed fleet size of combustion-engine vehicles (`log_ff`) is the most important predictor, followed by the amount of vehicles with hybrid or ethanol engines (`ethanol`) in the a given state. These two variables might just be proxies for population size.

Additionally, time-related variables (`years` and `months_nr`) also are relevant in the model, followed by the average yearly taxable income of the 50th and 100th percentiles (`avg_taxable_income_50` and `avg_taxable_income_100`, and specific Brazilian states as dummy variables (`sigla_uf`).

<br>

## Multivariate Adaptive Regression Splines

Multivariate Adaptive Regression Splines (MARS) will be employed to explore nonlinear model terms with automatic functions, by using the **earth** package. The goal will be to run algorithms with nonlinear model terms, with interaction effects, squared terms and other transformations, such as step functions.

Using the same data, these are the most important coefficients identified by the algorithm, as well as the number of terms selected and interactions.

```{r}

fleet_df_d <- fleet_df_c %>% 
  select(-c(population, date, year))

# Creating the MARS model object
mars1 <- earth(
  log(electric) ~ .,
  data = fleet_df_d
)

summary(mars1)

```

<br>

The summary of the MARS model indicates a high value for its R², which is a good performance for the model. Also, the 15 of the predictors have been kept, with 30 terms selected for the best performing model. The plot below shows the performance of the algorithm being used and the selected model based on number of terms and RSq and GRSq values.

```{r}

# Ploting the model selection
plot(mars1, which = 1)

```

<br>

```{r include=FALSE}
mars2 <- earth(
  log(electric) ~ .,
  data = fleet_df_d,
  degree = 2
)

# Summary of the most important predictors and interactions
summary(mars2) %>% .$coefficients %>% head(10)

# Preparing a grid with hyperparameters
hyper_grid <- expand.grid(
  degree = 1:3, 
  nprune = seq(2, 100, length.out = 10) %>% floor()
)

```

```{r include=FALSE}

# Training the algorithm 
set.seed(123)  # for reproducibility
cv_mars <- train(
  x = subset(fleet_df_d, select = -electric),
  y = fleet_df_d$electric,
  method = "earth",
  metric = "RMSE",
  trControl = trainControl(method = "cv", number = 10),
  tuneGrid = hyper_grid
)

# Finding the best hyperparameters
cv_mars$bestTune

# Plotting the RMSE according to the number of terms
ggplot(cv_mars)

```

```{r include = FALSE}
cv_mars$results %>%
  filter(nprune == cv_mars$bestTune$nprune, degree == cv_mars$bestTune$degree)

```

```{r include = FALSE}

# Mapping out the most relevant predictors
p1 <- vip(cv_mars, num_features = 25, geom = "point", value = "gcv") + ggtitle("GCV")
p2 <- vip(cv_mars, num_features = 25, geom = "point", value = "rss") + ggtitle("RSS")

# Population and log_pop are coming up as the most important predictors
# Maybe I should use a different predictor instead?

gridExtra::grid.arrange(p1, p2, ncol = 2)

```

```{r include=FALSE}

# Check for interactions
cv_mars$finalModel %>%
  coef() %>%  
  broom::tidy() %>%  
  filter(stringr::str_detect(names, "\\*")) 
# So far, the model is not yielding any relevant variables


cv_mars$finalModel %>%
  coef() %>%  
  broom::tidy() %>%  
  filter(stringr::str_detect(names, "\\*")) 

# Construct partial dependence plots
p1 <- partial(cv_mars, pred.var = "months_nr", grid.resolution = 10) %>% 
  autoplot()
p2 <- partial(cv_mars, pred.var = "log_pop", grid.resolution = 10) %>% 
  autoplot()
p3 <- partial(cv_mars, pred.var = c("months_nr", "log_pop"), 
              grid.resolution = 10) %>% 
  plotPartial(levelplot = FALSE, zlab = "yhat", drape = TRUE, colorkey = TRUE, 
              screen = list(z = -20, x = -60))

# Display plots side by side
gridExtra::grid.arrange(p1, p2, p3, ncol = 3)



```

<br>

------------------------------------------------------------------------

# Forecasting

## Regressions

A different approach attempted was to forecast values using an ARIMA (acronym for "AutoRegressive Integrated Moving Average") model, which aim to describe autocorrelations in the data and predict future outcome values based on the lagged values of $y_t$ and $\epsilon_t$ as predictors. For that purpose, the **forecast** package in R has been used.

```{r}

model1 <- lm(log(electric) ~ log(population) * months_nr, 
             data = fleet_df_c)

model2 <- lm(log(electric) ~ log(population) * months_nr + log(min_ev) + log(mean_gas) + log(mean_hyb),
             data = fleet_df_c)

model3 <- lm(log(electric) ~ log(population) * months_nr + log(min_ev) + log(mean_gas) + log(mean_hyb) +
               log(avg_taxable_income_50) + log(avg_taxable_income_100),
             data = fleet_df_c)




beer2 <- window(ausbeer, start=1992)
fit.beer <- tslm(beer2 ~ trend + season)
fcast <- forecast(fit.beer)
autoplot(fcast) +
  ggtitle("Forecasts of beer production using regression") +
  xlab("Year") + ylab("megalitres")

```

<br>

## ARIMA

A different approach attempted was to forecast values using an ARIMA (acronym for "AutoRegressive Integrated Moving Average") model, which aim to describe autocorrelations in the data and predict future outcome values based on the lagged values of $y_t$ and $\epsilon_t$ as predictors. For that purpose, the **forecast** package in R has been used.

```{r}


```

------------------------------------------------------------------------

# Next Steps

Based on the coefficients, statistical significance and R² values, the linear models obtained (with and without fixed effects) have shown a good performance. The corresponding tables suggest that the growth in BEV stock can be explained by population size, income levels, BEV prices. Additionally, Regularized Regressions and Multivariate Adaptive Regressions have been attempted, but the algorithms generated have not performed feature selection in a relevant way.

The next step now will be to to calculate and plot expected values of BEV stock for the coming years. For that, I will attempt two approaches:

1.  Generate synthetic data by using the coefficients obtained to calculate projected values for the EV stock in the coming years;

2.  Further explore different models (e.g. MARS, decision trees) and methods (e.g. ARIMA) to calculate projected values for the EV stock.

Afterwards, I will move to the second variable of the model, based on the OECD paper (2019); and will calculate the expected tax revenue impact of the further adoption of BEVs in the Brazilian market.
