---
title: "MT: Colloquium Preparation"
author: "Joao Vitor Krieger | joaovitorkgs"
date: "`r format(Sys.time(), '%B %d, %Y | %H:%M:%S | %Z')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    number_sections: true
    theme: united
    code_folding: hide
    df_print: paged
    highlight: tango
---

```{=html}
<style>
div.answer {background-color:#f3f0ff; border-radius: 5px; padding: 20px;}
div.comment {background-color:#F0F6FF; border-radius: 5px; padding: 20px;}

</style>
```

```{=html}
<style>
div.gradingadvice {background-color:#a2bc89; border-radius: 5px; padding: 20px;}
</style>
```

```{=html}
<style>
div.examplefeedback {background-color:#FFA500; border-radius: 5px; padding: 20px;}
</style>
```

```{=html}
<style>
div.lookfor {background-color:#a389bc; border-radius: 5px; padding: 20px;}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA)

knitr::opts_knit$set(root.dir = "C:/Users/joaov/Dropbox/R Assignments/master-thesis/")

```

------------------------------------------------------------------------

```{r, include = T}
pacman::p_load(
  # Core Data Manipulation and Tidying
  dplyr,        # Data manipulation: filtering, summarizing, mutating, and more
  tidyr,        # Data tidying and reshaping: pivoting, handling missing values
  janitor,      # Clean messy data (e.g., column names) and create summary tables
  
  # Data Import and Export
  readr,        # Read flat files (CSV, TSV) into tibbles
  readxl,       # Read Excel files (.xls, .xlsx) into data frames
  basedosdados, # Access Brazilian public data via BigQuery
  httr,         # Perform HTTP requests to interact with web APIs
  archive,      # Extract files from compressed archives (.zip, .tar.gz)
  
  # Data Visualization
  ggplot2,      # Create customizable data visualizations using the grammar of graphics
  scales,       # Format axes and legends (e.g., percentages, currencies)
  viridis,      # Color palettes for data visualization (colorblind-friendly)
  RColorBrewer, # Additional color palettes for plots
  
  # String Manipulation
  stringr,      # Simple and consistent string manipulation functions
  stringi,      # Advanced string manipulation with Unicode support
  
  # Date-Time Handling
  lubridate,    # Simplify date and time parsing and manipulation
  
  # Geographic and Spatial Data; specialized packages for Brazil
  geobr,        # Access Brazilian geographic data (e.g., shapefiles)
  deflateBr,     # Deflate nominal Brazilian Reais using price indexes
  sf,           # Handle spatial/geographic data in R
  
  # Reporting and Tables
  gt,           # Create publication-quality tables
  stargazer,    # Generate regression tables in LaTeX/HTML/text formats
  
  # Machine Learning and Statistics
  caret,        # Comprehensive machine learning framework (classification/regression)
  Metrics,      # Evaluate model performance (e.g., RMSE, MAE)
  glmnet,       # Regularized generalized linear models (Lasso, Ridge)
  earth,        # Multivariate Adaptive Regression Splines
  vip,          # Variable Importance Plots
  pdp,          # Partial Dependence Plots
  car,          # Companion to Applied Regression (diagnostic functions)
  DescTools,    # Tools for descriptive statistics
  rsample,      # Functions for resampling data
  plm           # Perform panel data analysis (fixed/random effects models)
)

```

------------------------------------------------------------------------

# Introduction

This document outlines the overall results I have achieved so far as part of my MT research and data work. It will focus on explaining some of the key data used, some descriptive statistics and results or information on the models attempted.

The research question consists of assessing the fiscal impact (in terms of tax revenue) of a greater adoption of electrical vehicles (EV) in Brazil, focusing exclusively on the shift from passenger cars with combustion engines to plug-in/battery powered EVs. To do that, I intend to use historical data on the country's fleet of passenger vehicles of all kinds and other relevant data (population size per state and city, income distribution on state level, vehicle prices) to understand the current rates of EV adoption in different states, and then use this information to extrapolate the data and run some projections on how the EV stock might grow in a timeframe of 10-15 years. From there, I would use different tax rates and estimate tax revenue scenarios, and discuss different policy recommendations.

This research draws mostly from methods discussed in these two sources:

-   OECD/ITF (2019), Tax Revenue Implications of Decarbonising Road Transport: Scenarios for Slovenia, OECD Publishing, Paris, <https://doi.org/10.1787/87b39a2f-en/>

-   Boehmke, B., & Greenwell, B.M. (2019). Hands-On Machine Learning with R (1st ed.). Chapman and Hall/CRC. <https://doi.org/10.1201/9780367816377>

## Descriptive statistics

During the initial data research, further descriptive statistics has been produced as a way of exploring the topic and what trends and important information might inform this thesis work.

------------------------------------------------------------------------

# Data used

## Overview

All data used has been obtained from publicly available data from Brazilian official sources, including:

-   National Traffic Secretariat (2024): fleet size per vehicle type (monthly data on city level).
-   Special Secretariat of the Federal Revenue of Brazil (RFB): income distribution and tax revenue.
-   Peixoto (2024): average vehicle prices by vehicle/fuel type (monthly data on national level).
-   Base dos Dados (2024): demographic and geographic data, including population size per city and state.

The data frames loaded below are already the product of the project's pipeline, including data scraping or downloading, cleaning and organizing for the purpose of this analysis.

```{r}

setwd("C:/Users/joaov/Dropbox/R Assignments/master-thesis/")

# Loading the data frames

fleet_2013_2024_clean <- read_csv("./3_processed_data/fleet_2013_2024_id_clean.csv")
price_df              <- read_csv("./3_processed_data/fipe_price_monthly_trends_deflated.csv")
income_data_wide_uf   <- read_csv("./3_processed_data/income_data_wide_uf.csv")

# Further transformation for the models

## Organizing population data and adding months

months <- fleet_2013_2024_clean %>% 
  arrange(date) %>%  
  distinct(date) %>%  
  mutate(months_nr = row_number()) 

fleet_df <- fleet_2013_2024_clean %>% 
  mutate(ev_pc        = electric / populacao,
         ff_pc        = (gasoline+diesel)/populacao,
         log_electric = log(electric),
         log_ff       = log(gasoline+diesel),
         log_pop      = log(populacao)) %>% 
  filter(log_electric >= 0) %>% 
  left_join(months, by="date")

fleet_df_b_city <- fleet_df %>% 
  left_join(price_df, by = "date") 

fleet_df_b_uf <- fleet_df %>% 
  left_join(price_df, by = "date") %>% 
  group_by(sigla_uf, date, months_nr) %>% 
  summarize(diesel     = sum(diesel),
            ethanol    = sum(ethanol),
            gasoline   = sum(gasoline),
            other      = sum(other),
            electric   = sum(electric),
            gas        = sum(gas),
            population = sum(populacao))

## Adding price information and grouping by state
fleet_df_b_uf <- fleet_df %>% 
  left_join(price_df, by = "date") %>% 
  group_by(sigla_uf, date, year, month, months_nr) %>% 
  summarize(diesel     = sum(diesel),
            ethanol    = sum(ethanol),
            gasoline   = sum(gasoline),
            other      = sum(other),
            electric   = sum(electric),
            gas        = sum(gas),
            population = sum(populacao),
            mean_gas   = mean(mean_price_gasoline),
            mean_hyb   = mean(mean_price_hybrid),
            mean_ev    = mean(mean_price_electric),
            median_gas = mean(median_price_gasoline),
            median_hyb = mean(median_price_hybrid),
            median_ev  = mean(median_price_electric),
            min_gas    = mean(min_price_gasoline),
            min_hyb    = mean(min_price_hybrid),
            min_ev     = mean(min_price_electric)) %>% 
  mutate(ff_pc        = (gasoline+diesel)/population,
         log_ff       = log(gasoline+diesel),
         log_pop      = log(population))

## Adding income distribution data
fleet_df_c <- fleet_df_b_uf %>% 
  left_join(income_data_wide_uf, by = c("year", "sigla_uf")) %>% 
  drop_na()


```

## Descriptive statistics

### EV stock and population size

The table below has a summary of the data frame combining population size ("`populacao`") on city level with the existing fleet of passenger cars by fuel type.

```{r, results = 'asis'}

fleet_2013_2024_clean <- fleet_2013_2024_clean %>% 
  mutate(id_municipio = as.character(id_municipio))

stargazer(as.data.frame(fleet_2013_2024_clean),
          title="Table 1: Summary statistics of data on pop. size and vehicle stock",
          column.sep.width = "15pt",
          digits=0,
          type = "html")

```

<br>

Exploring the data visually, I find that population has a clear positive correlation with the EV fleet size, though this may be somewhat obvious. I am not yet entirely sure if I should move forward with this variable as a predictor.

```{r}
ggplot(data = fleet_df_c, aes(x=population, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("EV Adoption vs. Population Size in in Brazilian States")+
  theme_bw() +
  ylab("Number of Registered Electric Vehicles (log)") +
  xlab("Population Size (log)") +
  scale_x_continuous(trans = "log10", labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4)  +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

<br>

### Price information

I have obtained a table with monthly prices of all vehicles being commercialized (new or used) in Brazil in a given month and year, from 2013 to 2022. The primary data is produced by FIPE, a research foundation that maintains a database on car prices to use as a parameter for individual transactions and valuation of any given car. I obtained this data from a secondary source (Peixoto, 2022), which scraped data from FIPE's website and made it publicly available.

By grouping data based on each model fuel or traction type (e.g. electric, gasoline, ethanol or hybrid), I have obtained mean, median, minimum and maximal prices, as well as the number of movels available in a given month and year.

```{r, results = 'asis'}

stargazer(as.data.frame(price_df),
          title="Table 2: Summary statistics of data on vehicle price",
          column.sep.width = "3pt",
          digits=0,
          type = "html")

```

<br>

When plotting the data, EV prices and EV stock seem to have some degree of correlation, suggesting that more EVs are bought as more affordable vehicles are available in the Brazilian market. However, the data points are oddly spread in the plot, as I do not have an explanation for these two clusters.

I used data on the cheapest EV model ("min_price_electric") available in the Brazilian market in a given month, and the EV stock size in the corresponding month.

```{r}
fleet_df_c %>% 
  filter(year > 2017) %>% 
  group_by(date) %>% 
  summarize(
    ev_price = mean(min_ev)/1000,
    electric = mean(electric)) %>% 
  ggplot(aes(x=ev_price, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  labs(
    title = "EV Adoption vs. EV minimum price in Brazil (2018-2022)",
  ) +
  theme_bw() +
  ylab("Number of Registered Electric Vehicles (log)") +
  xlab("EV average price (thousand BRL)") +
  scale_x_continuous(labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )

```

### Income Information

For data on income, I used data published by the Brazilian national treasury on income distribution. The original data set lists yearly data on different kinds of taxable income classes per income percentile. I have adjusted the values to show deflated BRL, and used only the bottom 10th percentile, the median, and the top 90 and 100 percentiles.

```{r, results = 'asis'}

stargazer(as.data.frame(income_data_wide_uf),
          title="Table 3: Summary statistics of data on income distribution",
          column.sep.width = "3pt",
          digits=0,
          type = "html")

```

When visualizing the data, the scatterplot below suggests that average taxable income of the richest percentile also seems to have a correlation with number of EVs in a given month. This suggests that acquiring an EV seems to be inaccessible for most of the population.

```{r}
fleet_df_c %>% 
  group_by(year, sigla_uf) %>% 
  summarize(
    avg_taxable_income_100 = mean(avg_taxable_income_100),
    electric = mean(electric)) %>% 
  ggplot(aes(x=avg_taxable_income_100, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("EV Adoption vs. Average income of top 100th Percentile in Brazilian States")+
  theme_bw() +
  ylab("Number of Registered Electric Vehicles (log)") +
  xlab("Average Taxable Income of the 100th Percentile (log)") +
  scale_x_continuous(trans = "log10", labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4) +
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

<br>

This correlation is not clear when looking into the average income for the 50th percentile (median). The plots suggest a negative correlation.

```{r}
fleet_df_c %>% 
  group_by(year, sigla_uf) %>% 
  summarize(
    avg_taxable_income_50 = mean(avg_taxable_income_50),
    electric = mean(electric)) %>% 
  ggplot(aes(x=avg_taxable_income_50, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("EV Adoption vs. Average income of the top 50th Percentile in Brazilian State")+
  theme_bw() +
  ylab("Number of Registered Electric Vehicles (log)") +
  xlab("Average Taxable Income of the 50th Percentile (log)") +
  scale_x_continuous(trans = "log10", labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4)+
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

<br>

This correlation is also not clear when looking into the average income for the bottom 10th percentile. The plots suggest a negative correlation.

```{r}

# Also not true for the bottom 10 percentile

fleet_df_c %>% 
  group_by(year, sigla_uf) %>% 
  summarize(
    avg_taxable_income_10 = mean(avg_taxable_income_10),
    electric = mean(electric)) %>% 
  ggplot(aes(x=avg_taxable_income_10, y=electric)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + # Add linear regression line
  ggtitle("EV Adoption vs. Average income of the bottom 10th Percentile in Brazilian State")+
  theme_bw() +
  ylab("Number of Registered Electric Vehicles (log)") +
  xlab("Average Taxable Income of the 50th Percentile (log)") +
  scale_x_continuous(labels = scales::comma) + # Log scale for x-axis with meaningful labels
  scale_y_continuous(trans = "log10", labels = scales::comma) +  # Log scale for y-axis with meaningful labels
  facet_wrap(~year, nrow = 3, ncol = 4)+
  theme(
    plot.title = element_text(size = 12),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```

<br>

------------------------------------------------------------------------

# Models

In order to project the EV stock in Brazil in relation to future years by using past data, I have attempted to establish models that can correctly predict the information already at hand. The goal is to find good predictors to explain the growth in the EV stock, which are statistically significant, and that have a logical mechanism that explains the relationship. Based on the coefficients found and the accuracy of the model, I will then create synthetic data which extrapolates the current EV stock to the future years, which will then be used to examine the impact of electrifying the passenger vehicle fleet in Brazil on tax revenue.

## Predictors

The predictors chosen thus far and their rationale were the following:

-   **Population size**: bigger cities and states are expected to have a more developed infrastructure, which would include charging infrastructure, as well as a bigger demand and offer for EVs.

-   **Fossil fuel Vehicles** : instead of owning multiple cars, I would expect a gradual substitution of vehicles running on fossil fuels (chiefly gasoline) by EVs as the stock of the latter increases.

-   **Time**: due to recent trends, evolving consumer preferences, markets and available technologies, as well as a growing concern with climate change in recent years and the negative impacts of CO2 emitting cars, time (number of months passed) was included as a predictor.

-   **Vehicle prices**: the first EV models available in 2013 were twice as expensive as the cheapest models currently available. As the EV become more affordable, the overall EV stock is expected to increase.

-   **Income**: in spite of recent EV models becoming gradually less expensive, the cost of the cheapest models still is significantly higher than that of gasoline or hybrid vehicles. This would mean that cities and states with a higher average income of the top percentiles of the population would have a bigger EV stock as well.

These predictors might also have some degree of multicollinearity. For example, larger cities and states tend to also be richer. Population growth and price changes are also correlated with the predictor related to time. This means that the predictors might introduce bias or have a limited capacity of explaining the increase in EVs in the models.

## Linear regressions

The first and most simple models were simple linear regressions (OLS), where the EV stock (the log-transformed number of registered EVs in a given month in all Brazilian states) was regressed on population size and time. Another model includes the interaction between time and population, as well as with the number of other kinds of vehicles in the fleet.

```{r, results = 'asis'}

model1 <- lm(log(electric) ~ log(population) * months_nr, 
             data = fleet_df_c)

model2 <- lm(log(electric) ~ log(population) * months_nr + log(min_ev) + log(mean_gas) + log(mean_hyb),
             data = fleet_df_c)

model3 <- lm(log(electric) ~ log(population) * months_nr + log(min_ev) + log(mean_gas) + log(mean_hyb) +
               log(avg_taxable_income_50) + log(avg_taxable_income_100),
             data = fleet_df_c)


stargazer(model1, model2, model3, type = "html",
          title=
            "Table 4: EV stock regressed on population size, time, price & income (linear regression)",
          single.row= FALSE,
          column.labels =c("Model 1","Model 2", "Model 3", "Model 4"),
          covariate.labels=c("Population (log)",
                             "Months",
                             "Vehicle price - electric (log)",
                             "Vehicle price - gasoline (log)",
                             "Vehicle price - hybrid (log)",
                             "Avg. Income - 50th perc. (log)",
                             "Avg. Income - 100th perc. (log)",
                             "Vehicle price - hybrid (log)",
                             "Months : Population (log)"),
          keep.stat = c("rsq", "f"),
          notes.align = "l",
          dep.var.labels=c("EV stock (log)"))

```

<br>

**Interpretation:**

The above regression tables shows state-level data where the EV stock is regressed on log-transformed population, months, average car prices per vehicle type and an interactions between population and time-related variable.

The regression with the most variables seems to perform well, based on the statistical significance of the coefficients, as well as the R² and F-Statistic values. It corroborates some of the initial assumptions and expected relationships for most of the independent variables, including increases on population size, time effects, and the influence of prices of vehicles, which also have the correct direction (e.g. EV prices have a negative coefficient).

As for the effect of income — measured here as the annual average taxable income of the 50th and 100th top percentiles — in each state, the median average income seems to have a positive correlation, but the average income of the top earners in Brazilian states has no statistically significant effect, with an unexpected negative correlation.

## Panel Data and Fixed-Effects

As an improvement to the linear regressions above, the following regressions incorporate fixed effects for the used units of observations (i.e. states), in order to focus on variance within units and account for the natural and significant differences between states.

```{r, results = 'asis'}


panel_data <- pdata.frame(fleet_df_c, index = c("sigla_uf", "date"))

fe_model_1 <- plm(log(electric) ~ log(population) + as.factor(months_nr),
                  data  = panel_data,
                  model = "within")

fe_model_2 <- plm(log(electric) ~ log(population) + log(min_ev) + log(mean_gas) + log(mean_hyb) + as.factor(months_nr),
                  data  = panel_data,
                  model = "within")

fe_model_3 <- plm(log(electric) ~ log(population) + log(min_ev) + log(mean_gas) + log(mean_hyb) + log(avg_taxable_income_50) + log(avg_taxable_income_100) + as.factor(months_nr),
                  data  = panel_data,
                  model = "within")


stargazer(fe_model_1, fe_model_2, fe_model_3, type = "html",
          title = "Table 5: EV stock regressed on population size, time, vehicle prices and income with panel data and fixed effects",
          single.row = FALSE,
          dep.var.labels = c("EV stock (log)"),
          covariate.labels=c("Population (log)",
                             "Vehicle price - electric (log)",
                             "Vehicle price - gasoline (log)",
                             "Vehicle price - hybrid (log)",
                             "Avg. Income - 50th perc. (log)",
                             "Avg. Income - 100th perc. (log)"),
          column.labels = c("Model 1", "Model 2", "Model 3"),
          keep.stat = c("rsq", "f"),
          notes.align = "l",
          omit = "as.factor\\(months_nr\\)[0-9]+")


```

<br>

**Interpretation:**

The regression with panel data and fixed-effects has a better performance, with the R² value in all three models being around 0.93. It also indicates an increased effect from population and vehicle prices, especially for the price of EVs, when compared to the linear regressions with no fixed effects. The results from table 5 suggest that, on average, a 1% decrease on the average vehicle price for the cheapest EV available on the market on a given month is associated to a 5.4% increase on the EV stock.

As for the effect of income, the median average income seems to have a now a negative effect, as well as the average income of the top earners in each state. This is an unexpected effect of the correlation between income and EV stock.

<br>

## Regularized Regressions

A further step in the analysis was to regularized the estimate coefficients, to reduce variance and decrease out of sample error. The following code shows applications of the ridge regression to add a tuning parameter (`lambda`) to force correlated coefficients and less important predictors toward zero, thus reducing collinearity. Additionally, a lasso penalty (least absolute shrinkage and selection operator) was also introduced, to push correlated coefficients and irrelevant predictors to zero, using automated feature selection.

The goal of using these methods is to identifying a model where the MSE (Mean Squared Error) is minimized. In this case, the MSE will be used to determine the statistical significance of the factors or predictors under study.

For this section of analysis, additional features were included to the data set, such as mean, median and minimum prices for EVs, hybrid and gasoline vehicles; the fleet size for vehicles of all engine/fuel types; as well as the log-transformed population size (`log_pop`) and size of the vehicle stock with combustion engines (`log_ff`), and the ratio of vehicles with combustion engines per capita (`ff_pc`).

```{r}

# Create training  feature matrices
# we use model.matrix(...)[, -1] to discard the intercept

library(glmnet)

X <- modglmnetX <- model.matrix(log(electric) ~ ., fleet_df_c)[, -1]
Y <- log(fleet_df_c$electric)

# Ridge model
ridge <- glmnet(
  x = X,
  y = Y,
  alpha = 0
)

# Lasso model
lasso <- glmnet(
  x = X,
  y = Y,
  alpha = 1
)

par(mfrow = c(1, 2))
# plot ridge model
plot(ridge, xvar = "lambda", main = "Ridge penalty\n\n")

# plot lasso model
plot(lasso, xvar = "lambda", main = "Lasso penalty\n\n")


```

<br>

The plot above shows the coefficients' value being pushed towards zero as the `lambda` value increases. However, differently from the examples in Boehmke & Greenwell (2019), where dashed lines were plotted for the `lambda` values with the smallest MSE and at one standard error of the minimum MSE, this model returns a `NULL` value for these `lambda` values:

```{r, show = T}
ridge$lambda.min
ridge$lambda.1se
lasso$lambda.min
lasso$lambda.1se
```

<br>

This might mean the algorithm was unable to determine an optimal regularization parameter for the data set being used, either because the model is not converging to any of the attempted `lambda` values, or because the multicollinearity among the predictors makes it difficult for the algorithm to determine the appropriate `lambda` value. Also, given the good performance of the previous linear regressions, it might mean that the model is overfitted, i.e. it performs well to explain the relationship between independent and dependent variables with the data existing, but it performs poorly with new data.

Following Boehmke & Greenwell (2019), a workaround to this was to use the **caret** package to automate the tuning process (i.e. chosing the parameters to optimize the model and find the lowest regularized MSE). The code output below shows the chosen `lambda` value, which penalizes the existing predictors; and the `alpha` value (which determines whether the **glmnet** package should perform a ridge (`alpha = 0`), lasso (`alpha = 1`) or elastic net (`0 < alpha < 1`) model.

```{r}

# for reproducibility
set.seed(123)

# grid search across 
cv_glmnet <- train(
  x = X,
  y = Y,
  method = "glmnet",
  preProc = c("zv", "center", "scale"),
  trControl = trainControl(method = "cv", number = 10),
  tuneLength = 10
)

cv_glmnet$results %>%
  filter(alpha == cv_glmnet$bestTune$alpha, lambda == cv_glmnet$bestTune$lambda)

```

<br>

The results show an `alpha` value of 0.3, which means the model uses an elastic net regression, with a heavier ridge penalty. However, the `lambda` value is very low, close to 0, which means the model is applying very little regularization, thus behaving similarly to a standard linear regression, without performing much feature selection.

When using this model to predict the number of EVs using training data, the algorithm returns an RSME of 368.

```{r}

# predict number of electric vehicles on training data
pred <- predict(cv_glmnet, X)

# compute RMSE of transformed predicted
RMSE(exp(pred), exp(Y))

```

<br>

While this may be a good enough standard error for most of the states or for the aggregated fleet (on national level), the error makes the predicted values statistically insignificant for three out of the 25 Brazilian states (AC, AP, RR), as seen in the plot below.

```{r}
fleet_df_c %>% 
  select(year, sigla_uf, electric) %>% 
  filter(year == 2022) %>% 
  group_by(sigla_uf) %>% 
  summarize(
    EVs = max(electric)
  ) %>% 
  arrange((EVs)) %>% 
  mutate(sigla_uf = factor(sigla_uf, levels = sigla_uf)) %>% 
  ggplot(aes(y = sigla_uf, x = EVs)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = comma(EVs)), hjust = -0.1, size = 3) +
  scale_x_continuous(labels = comma) +
  ggtitle("Number of EVs registered per Brazilian State in 2022") +
  xlab("Number of Observations") +
  ylab("Brazilian States") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```

<br>

Lastly, the plot below shows the 20 variables with the greatest importance, as determined by the magnitude of the standardized coefficients.

```{r}

vip(cv_glmnet, num_features = 20, geom = "point")


```

<br>

This shows the most influential features in the model were different from the linear regressions with no regularized estimate coefficients. In this plot, the log transformed fleet size of combustion-engine vehicles (`log_ff`) is the most important predictor, followed by the amount of vehicles with hybrid or ethanol engines (`ethanol`) in the a given state. These two variables might just be proxies for population size.

Additionally, time-related variables (`years` and `months_nr`) also are relevant in the model, followed by the average yearly taxable income of the 50th and 100th percentiles (`avg_taxable_income_50` and `avg_taxable_income_100`, and specific Brazilian states as dummy variables (`sigla_uf`).
